# GitHub Copilot Instructions - Portfolio Analysis Agent Group

## Overview

This agent group provides a **Python library + code-writing agent** system for comprehensive portfolio analysis. The `portfolio_toolkit` library contains tested functions for data loading, financial calculations, risk assessment, visualization, and reporting. The `portfolio-code-writer` agent generates complete scripts using this library.

**Version**: 2.0.0 (Breaking change from v1.0.0 - see CHANGELOG.md)

**This is a portable agent group following the standard structure and can be dropped into any repository.**

## Agent Group Purpose

Generate high-quality, executable Python scripts for analyzing investment portfolios. Users can either:
- **Beginner**: Talk to `portfolio-code-writer` agent to get generated scripts
- **Advanced**: Import `portfolio_toolkit` library directly and write their own code

## Architecture: Library + Agent

### portfolio_toolkit Library (NEW in v2.0.0)

A comprehensive Python library providing five modules:

**1. data module** - Data loading and cleaning
- `load_portfolio_csv()`, `load_portfolio_excel()`
- `fetch_price_history()` - Get prices from yfinance
- `clean_portfolio_data()`, `validate_portfolio_data()`

**2. metrics module** - Financial calculations
- `calculate_returns()`, `calculate_cagr()`, `calculate_volatility()`
- `calculate_sharpe_ratio()`, `calculate_sortino_ratio()`
- `calculate_max_drawdown()`, `calculate_alpha_beta()`
- `calculate_portfolio_statistics()` - Comprehensive metrics

**3. risk module** - Risk assessment
- `calculate_var()`, `calculate_cvar()` - Value at Risk
- `monte_carlo_simulation()` - Future portfolio distribution
- `stress_test()` - Historical scenario analysis
- `calculate_risk_metrics()` - Comprehensive risk profile

**4. viz module** - Visualizations
- `plot_cumulative_returns()`, `plot_drawdown()`
- `plot_return_distribution()`, `plot_correlation_heatmap()`
- `plot_performance_dashboard()` - Multi-panel dashboard

**5. reports module** - Report generation
- `generate_html_report()`, `generate_markdown_report()`
- `export_metrics_to_excel()`

**Installation**:
```bash
cd portfolio-analysis
pip install -e .
```

---

## The Three Agents

### 1. Portfolio Code Writer (`portfolio-code-writer.agent.md`) - NEW in v2.0.0
**Model**: Claude Sonnet 4.5 (copilot)  
**Role**: Unified code generation using portfolio_toolkit library

**When to use**:
- Generating complete portfolio analysis scripts
- Creating custom analysis workflows
- Chaining data → metrics → risk → visualization → reports
- Adapting library functions to specific requirements

**What it does**:
- Imports and uses `portfolio_toolkit` modules
- Generates complete, executable Python scripts
- Handles user-specific requirements (file paths, date ranges, metrics)
- Includes error handling and validation
- Provides usage instructions

**Handoffs**:
- To **Code Quality Reviewer** for code review
- To **Devil's Advocate** for critical review of assumptions

**Example output**: Complete Python script with:
```python
from portfolio_toolkit import data, metrics, risk, viz, reports

def main():
    # Load data
    portfolio = data.load_portfolio_csv('portfolio.csv')
    
    # Calculate metrics
    returns = metrics.calculate_returns(prices)
    stats = metrics.calculate_portfolio_statistics(returns)
    
    # Risk assessment
    var_95 = risk.calculate_var(returns, 0.95)
    
    # Visualizations
    fig = viz.plot_cumulative_returns(returns)
    
    # Generate report
    reports.generate_html_report(stats, {'cumulative': 'chart.png'})
```

---

### 2. Code Quality Reviewer (`code-quality-reviewer.agent.md`)
**Model**: Claude Sonnet 4.5 (copilot)  
**Role**: Code quality and best practices review

**When to use**:
- Reviewing scripts generated by portfolio-code-writer
- Checking for PEP 8 compliance, type hints, docstrings
- Validating error handling and edge cases
- Suggesting performance optimizations

**Handoffs**:
- To **Portfolio Code Writer** for revisions
- To **Devil's Advocate** for critical review before delivery

---

### 3. Devil's Advocate (`devils-advocate.agent.md`) - MANDATORY
**Model**: Claude Sonnet 4.5 (copilot)  
**Role**: Critical review and assumption challenging

**When to use** (REQUIRED for all deliverables):
- Final quality gate before code delivery to user
- Challenging assumptions made by agents
- Identifying blind spots and edge cases
- Surfacing disagreements between agents
- Documenting trade-offs for human decisions

**Handoffs**:
- Back to originating agents for revisions (if issues found)
- To **Code Quality Reviewer** after approval (for final packaging)
- To **Portfolio Data Engineer** for architectural perspective (if needed)

---

## Workflow Diagram

### v2.0.0 Workflow (Current)

```
User Request
     ↓
Portfolio Code Writer (generates complete script using portfolio_toolkit)
     ↓
Code Quality Reviewer (code review)
     ↓
Devil's Advocate (critical review - MANDATORY)
     ↓
User (final code delivery)

[Agents can hand back to Portfolio Code Writer for revisions]
```

**Key Changes from v1.0.0**:
- Single code generation step (portfolio-code-writer) instead of 5 sequential agents
- Scripts use pre-built portfolio_toolkit library functions
- Faster workflow (1 handoff vs 5)

---

## Decision Trees

### Master Decision: What do you want to do?

```
START: What portfolio analysis task do you need?
  │
  ├─ [A] GENERATE COMPLETE ANALYSIS SCRIPT (Beginner)
  │   → Use @portfolio-code-writer
  │   Examples:
  │   - "Analyze my portfolio from portfolio.csv"
  │   - "Generate risk assessment script with VaR and stress tests"
  │   - "Create full report with all metrics and charts"
  │   - "Compare my portfolio against S&P 500"
  │
  ├─ [B] USE LIBRARY DIRECTLY (Advanced)
  │   → Import portfolio_toolkit modules in your own code
  │   Examples:
  │   ```python
  │   from portfolio_toolkit import data, metrics, risk, viz
  │   portfolio = data.load_portfolio_csv('portfolio.csv')
  │   stats = metrics.calculate_portfolio_statistics(returns)
  │   ```
  │
  ├─ [C] REVIEW CODE QUALITY
  │   → Use @code-quality-reviewer
  │   Examples:
  │   - "Review this portfolio analysis code"
  │   - "Check for best practices"
  │   - "Suggest optimizations"
  │
  └─ [D] CHALLENGE ASSUMPTIONS / CRITICAL REVIEW
      → Use @devils-advocate (also runs automatically before delivery)
      Examples:
      - "Review this risk model for blind spots"
      - "Challenge assumptions in this calculation"
      - "What edge cases are missing?"
```

### Detailed Workflow: Beginner (Agent-Assisted)

```
1. User describes analysis needs to @portfolio-code-writer
   ↓
2. Agent asks clarifying questions (data format, date range, goals)
   ↓
3. Agent generates complete Python script using portfolio_toolkit
   ↓
4. Agent hands off to @code-quality-reviewer
   ↓
5. Code Quality Reviewer checks quality, suggests improvements
   ↓
6. Agent revises if needed (iterative loop)
   ↓
7. Agent hands off to @devils-advocate
   ↓
8. Devil's Advocate challenges assumptions, identifies edge cases
   ↓
9. Agent addresses critical feedback (if needed)
   ↓
10. Final script delivered to user with usage instructions
```

### Detailed Workflow: Advanced (Direct Library)

```
1. User installs portfolio_toolkit: pip install -e portfolio-analysis/
   ↓
2. User writes Python code importing library modules
   ↓
3. (Optional) User consults @code-quality-reviewer for review
   ↓
4. (Optional) User consults @devils-advocate for critical review
   ↓
5. User runs their own code
```

---

## Quality Gates

### Gate 1: Script Completeness (Portfolio Code Writer)
- [ ] Script is complete and executable (no placeholders)
- [ ] All imports from portfolio_toolkit are correct
- [ ] Configuration section provided for customization
- [ ] Error handling includes try-except blocks
- [ ] Validation checks for data quality included
- [ ] Results displayed in readable format
- [ ] Usage instructions comprehensive
- [ ] Dependencies explicitly listed

### Gate 2: Library Function Usage (Portfolio Code Writer)
- [ ] Uses portfolio_toolkit modules (not inline implementations)
- [ ] Function parameters match library API
- [ ] Return types handled correctly
- [ ] Edge cases considered (missing data, API failures)
- [ ] Workflow chains logically (data → metrics → risk → viz → report)
- [ ] Results make financial sense

### Gate 3: Code Quality (Code Quality Reviewer)
- [ ] PEP 8 compliant
- [ ] Type hints present
- [ ] Docstrings comprehensive
- [ ] Error handling robust
- [ ] Performance optimized
- [ ] Testing recommendations provided

### Gate 4: Critical Review (Devil's Advocate) - MANDATORY
- [ ] All assumptions challenged
- [ ] Blind spots identified
- [ ] Disagreements documented
- [ ] Edge cases considered
- [ ] Trade-offs analyzed
- [ ] Human decisions flagged
- [ ] Residual risks documented

**CRITICAL**: No code is delivered to users without Devil's Advocate approval.

---

## Common Patterns

### Pattern 1: Quick Portfolio Analysis
```
User: "Analyze my portfolio in portfolio.csv"

Flow (v2.0.0):
1. @portfolio-code-writer → Generate complete analysis script
2. @code-quality-reviewer → Review code quality
3. @devils-advocate → Critical review
4. Deliver script to user

(v1.0.0 required 5+ agent handoffs)
```

### Pattern 2: Risk-Focused Analysis
```
User: "What's my portfolio risk?"

Flow (v2.0.0):
1. @portfolio-code-writer → Generate risk assessment script (VaR, stress tests, visualizations)
2. @code-quality-reviewer → Review code
3. @devils-advocate → Critical review
4. Deliver script to user

(v1.0.0 required 6+ agent handoffs)
```

### Pattern 3: Full Report Generation
```
User: "Create complete portfolio report"

Flow (v2.0.0):
1. @portfolio-code-writer → Generate comprehensive report script (all modules)
2. @code-quality-reviewer → Review code
3. @devils-advocate → Critical review
4. Deliver script to user

(v1.0.0 required 8 agent handoffs)
```

### Pattern 4: Advanced - Direct Library Usage
```
User writes Python code directly:

from portfolio_toolkit import data, metrics, risk, viz, reports

# Load data
portfolio = data.load_portfolio_csv('portfolio.csv')
prices = data.fetch_price_history(symbols, '2023-01-01', '2024-12-31')

# Calculate metrics
returns = metrics.calculate_returns(prices)
stats = metrics.calculate_portfolio_statistics(returns)

# Risk assessment
var_95 = risk.calculate_var(returns, 0.95)

# Visualization
fig = viz.plot_cumulative_returns(returns)
viz.save_figure(fig, 'performance.png')

# Report
reports.generate_html_report(stats, {'performance': 'performance.png'})
```

---

## Python Dependencies

### Core Libraries
```python
pandas>=2.0.0          # Data manipulation
numpy>=1.24.0          # Numerical operations
matplotlib>=3.7.0      # Basic plotting
seaborn>=0.12.0        # Statistical visualizations
yfinance>=0.2.28       # Yahoo Finance API (free)
scipy>=1.10.0          # Statistical functions
```

### Optional Libraries
```python
plotly>=5.14.0         # Interactive charts
reportlab>=4.0.0       # PDF generation
weasyprint>=59.0       # HTML to PDF
jinja2>=3.1.2          # HTML templating
squarify>=0.4.3        # Treemap charts
alpha-vantage>=2.3.0   # Alpha Vantage API
```

### Installation

**Install portfolio_toolkit library**:
```bash
cd portfolio-analysis
pip install -e .  # Development mode (editable)
```

This installs core dependencies automatically:
- pandas, numpy, matplotlib, seaborn, scipy

**Optional extras**:
```bash
pip install -e ".[data]"      # yfinance for price data
pip install -e ".[reports]"   # jinja2, reportlab for reports
pip install -e ".[full]"      # All optional dependencies
```

---

## Examples

### Example 1: Quick Analysis (v2.0.0)

**User Request**:
```
"Analyze my portfolio in portfolio.csv for the last year. Show performance metrics and a chart."
```

**Agent Sequence**:
```
1. @portfolio-code-writer
   → Generates complete script using portfolio_toolkit:
      - Loads CSV with data.load_portfolio_csv()
      - Fetches prices with data.fetch_price_history()
      - Calculates metrics with metrics.calculate_portfolio_statistics()
      - Creates chart with viz.plot_cumulative_returns()
   → Includes error handling, validation, usage instructions

2. @code-quality-reviewer
   → Reviews code quality, PEP 8 compliance
   → Suggests minor improvements

3. @devils-advocate
   → Challenges equal-weight assumption (should be value-weighted?)
   → Identifies edge case: missing price data handling
   → Documents limitations
   → Approves for delivery

4. User receives complete, executable script
```

### Example 2: Risk Assessment (v2.0.0)

**User Request**:
```
"Calculate 95% VaR and run Monte Carlo simulation for my portfolio"
```

**Agent Sequence**:
```
1. @portfolio-code-writer
   → Generates risk assessment script:
      - Uses risk.calculate_var() for VaR
      - Uses risk.monte_carlo_simulation() for simulations
      - Uses viz module for distribution charts
      - Includes stress test scenarios
   → Documents assumptions clearly

2. @devils-advocate
   → Challenges normal distribution assumption
   → Identifies limitation: tail risk may be underestimated
   → Suggests stress test with historical scenarios
   → Approves with documented limitations

3. User receives script with clear assumptions and limitations
```

### Example 3: Direct Library Usage (Advanced)

**User Code**:
```python
"""User writes their own analysis code using portfolio_toolkit."""

from portfolio_toolkit import data, metrics, risk, viz, reports
import pandas as pd

# Load portfolio
portfolio = data.load_portfolio_csv('portfolio.csv')
validation = data.validate_portfolio_data(portfolio)

if validation['valid']:
    # Fetch prices
    symbols = portfolio['symbol'].unique()
    prices = data.fetch_price_history(symbols, '2023-01-01', '2024-12-31')
    
    # Calculate metrics
    returns = metrics.calculate_returns(prices)
    portfolio_returns = returns.mean(axis=1)  # Equal-weighted
    stats = metrics.calculate_portfolio_statistics(portfolio_returns)
    
    # Risk assessment
    var_95 = risk.calculate_var(portfolio_returns, 0.95)
    mc_results = risk.monte_carlo_simulation(portfolio_returns)
    
    # Visualizations
    fig1 = viz.plot_cumulative_returns(portfolio_returns)
    viz.save_figure(fig1, 'performance.png')
    
    fig2 = viz.plot_drawdown((1 + portfolio_returns).cumprod())
    viz.save_figure(fig2, 'drawdown.png')
    
    # Generate report
    all_metrics = {**stats, 'var_95': var_95}
    chart_paths = {'performance': 'performance.png', 'drawdown': 'drawdown.png'}
    reports.generate_html_report(all_metrics, chart_paths)
    
    print("Analysis complete! See portfolio_report.html")
else:
    print(f"Data validation failed: {validation['issues']}")
```

**Optional Review**:
User can still consult @code-quality-reviewer or @devils-advocate for review of their code.

---

## Troubleshooting

### Issue: "No data available for symbol XYZ"
**Agent**: Portfolio Data Engineer  
**Solution**: 
- Verify symbol is correct (check ticker on Yahoo Finance)
- Some delisted stocks may not have data
- Use alternative data source (Alpha Vantage) if available

### Issue: "Sharpe ratio is NaN"
**Agent**: Portfolio Analyst  
**Cause**: Zero volatility (all returns identical)  
**Solution**:
- Check if data has sufficient variation
- Verify returns are calculated correctly
- Use longer time period for more data points

### Issue: "Correlation matrix is singular"
**Agent**: Portfolio Risk Assessor  
**Cause**: Perfect correlation between assets  
**Solution**:
- Check for duplicate symbols in portfolio
- Remove perfectly correlated assets
- Use regularization techniques

### Issue: "PDF generation fails"
**Agent**: Portfolio Report Generator  
**Cause**: Missing dependencies (ReportLab or WeasyPrint)  
**Solution**:
```bash
pip install reportlab
# or
pip install weasyprint
```

### Issue: "Code is slow for large portfolios"
**Agent**: Code Quality Reviewer  
**Solution**:
- Use vectorized pandas operations
- Avoid loops over DataFrame rows
- Cache API results
- Consider chunking for very large datasets (>10,000 symbols)

---

## Best Practices

### Data Handling
1. Always validate input data before calculations
2. Handle missing values explicitly (don't silently forward-fill)
3. Use adjusted close prices (split-adjusted)
4. Validate date ranges (no future dates)
5. Check for delisted securities

### Financial Calculations
1. Use industry-standard formulas
2. Annualize correctly (252 trading days for daily data)
3. Handle edge cases (zero volatility, negative returns)
4. Document all assumptions clearly
5. Provide multiple risk measures (not just one)

### Code Quality
1. Include type hints on all functions
2. Write comprehensive docstrings
3. Use proper error handling with informative messages
4. Add logging for debugging
5. Make code testable (modular functions)

### Risk Management
1. Always calculate multiple risk metrics (VaR, CVaR, stress tests)
2. Document distributional assumptions
3. Provide confidence intervals
4. Include disclaimers about limitations
5. Consider tail risks explicitly

---

## Version History

- **1.0.0** - Initial portfolio analysis agent group with 7 agents: Data Engineer, Analyst, Risk Assessor, Visualizer, Report Generator, Code Quality Reviewer, and Devil's Advocate (mandatory critical review)

---

## Integration Notes

This agent group is portable and can be dropped into any repository. To use:

1. Copy `portfolio-analysis/` folder to your repository
2. Install portfolio_toolkit: `cd portfolio-analysis && pip install -e .`
3. **Beginner**: Start with @portfolio-code-writer to generate scripts
4. **Advanced**: Import portfolio_toolkit modules in your own Python code
5. All agent-generated code automatically goes through Devil's Advocate critical review

---

## Migration from v1.0.0

If you used v1.0.0 agents:
- Old agents (@portfolio-data-engineer, @portfolio-analyst, etc.) are archived in `archive/v1/`
- Use @portfolio-code-writer for new script generation
- Existing v1.0.0 generated code still works (no forced migration)
- To migrate: Refactor inline functions to import from portfolio_toolkit, or regenerate with @portfolio-code-writer
- See CHANGELOG.md for complete migration guide

---

## Version History

- **2.0.0** (2025-12-16): Architecture redesign - replaced 5 code-generation agents with 1 unified agent + portfolio_toolkit library. Breaking change with comprehensive migration guide.
- **1.0.0** (2024-12-15): Initial release with 7 agents for multi-step portfolio analysis code generation.

---

## Disclaimer

This agent group generates code for portfolio analysis. The generated code and portfolio_toolkit library are for informational and educational purposes only and do not constitute financial advice. Always validate calculations independently and consult with qualified financial advisors before making investment decisions.
